<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Monthly Budget Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #f5f1e8 0%, #faf8f3 100%);
            color: #6b5d52;
            min-height: 100vh;
            padding: 20px;
        }
        .popup-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            display:flex; justify-content:center; align-items:center;
            z-index:1000;
        }
        .popup {
            background:#fff; padding:40px; border-radius:20px;
            box-shadow:0 10px 40px rgba(0,0,0,0.2);
            max-width:400px; width:90%;
        }
        .popup h2 { color:#8b7355; margin-bottom:30px; text-align:center; font-size:28px; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:8px; color:#6b5d52; font-weight:500; }
        .form-group input, .form-group select {
            width:100%; padding:12px; border:2px solid #e8dfd3;
            border-radius:10px; font-size:16px; background:#faf8f3; color:#6b5d52;
            transition:border .3s;
        }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:#c9b8a3; }
        .btn-primary {
            width:100%; padding:14px; background:#a68a6d; color:#fff;
            border:none; border-radius:10px; font-size:18px; cursor:pointer;
            transition:background .3s;
        }
        .btn-primary:hover { background:#8b7355; }
        .hidden { display:none; }
        header { text-align:center; margin-bottom:30px; }
        .editable-header {
            display:flex; justify-content:center; align-items:center;
            gap:20px; margin-bottom:10px; flex-wrap:wrap;
        }
        .editable-field {
            display:inline-flex; align-items:center; gap:10px;
            background:#fff; padding:10px 15px; border-radius:10px;
            box-shadow:0 2px 10px rgba(0,0,0,0.05);
        }
        .editable-field input, .editable-field select {
            border:1px solid #e8dfd3; padding:5px 10px;
            border-radius:5px; font-size:14px; background:#faf8f3;
        }
        h1 { color:#8b7355; font-size:42px; margin-bottom:5px; }
        h2 { color:#a68a6d; font-size:24px; font-weight:400; }
        .summary-cards {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:20px; margin-bottom:40px;
        }
        .card {
            background:#fff; padding:25px; border-radius:15px;
            box-shadow:0 4px 15px rgba(0,0,0,0.08);
            text-align:center; transition:transform .3s;
        }
        .card:hover { transform:translateY(-5px); }
        .card h3 { color:#8b7355; font-size:14px; font-weight:500;
            margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; }
        .card .amount { color:#6b5d52; font-size:28px; font-weight:600; }
        .charts-container {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:30px; margin-bottom:40px;
        }
        .chart-card {
            background:#fff; padding:25px; border-radius:15px;
            box-shadow:0 4px 15px rgba(0,0,0,0.08);
        }
        .chart-card h3 { color:#8b7355; margin-bottom:20px; text-align:center; font-size:18px; }
        .tables-container {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:30px; margin-bottom:30px;
        }
        .table-card {
            background:#fff; padding:25px; border-radius:15px;
            box-shadow:0 4px 15px rgba(0,0,0,0.08);
        }
        .table-card h3 { color:#8b7355; margin-bottom:15px; font-size:20px; }
        .add-row-container { text-align:center; padding:10px 0; border-bottom:2px solid #f5f1e8; }
        table { width:100%; border-collapse:collapse; }
        th { background:#f5f1e8; color:#8b7355; padding:12px; text-align:left;
            font-weight:500; border-radius:8px 8px 0 0; }
        td { padding:10px 12px; border-bottom:1px solid #f5f1e8; }
        td input {
            width:100%; border:1px solid #e8dfd3; padding:8px;
            border-radius:5px; background:#faf8f3; color:#6b5d52;
        }
        td input:focus { outline:none; border-color:#c9b8a3; }
        .total-row { font-weight:600; background:#f5f1e8; color:#8b7355; }
        .btn-icon {
            background:#a68a6d; color:#fff; border:none;
            width:30px; height:30px; border-radius:50%; cursor:pointer;
            font-size:18px; display:inline-flex; align-items:center;
            justify-content:center; transition:background .3s;
        }
        .btn-icon:hover { background:#8b7355; }
        .btn-remove { background:#d9a89a; }
        .btn-remove:hover { background:#c89080; }
        .actions-bar {
            display:flex; justify-content:center; gap:15px;
            margin-top:30px; flex-wrap:wrap;
        }
        .btn-action {
            padding:12px 30px; border:none; border-radius:10px;
            cursor:pointer; font-size:16px; transition:all .3s;
            font-weight:500;
        }
        .btn-clear { background:#d9a89a; color:#fff; }
        .btn-clear:hover { background:#c89080; }
        .btn-export { background:#a68a6d; color:#fff; }
        .btn-export:hover { background:#8b7355; }
        @media (max-width:768px){
            h1{font-size:32px;}
            .summary-cards,.charts-container,.tables-container{grid-template-columns:1fr;}
        }
        canvas { max-height:300px; width:100% !important; height:auto !important; display:block; }
    </style>
</head>
<body>

<!-- POPUP (Month + Currency only) -->
<div id="popup" class="popup-overlay">
    <div class="popup">
        <h2>Welcome!</h2>
        <form id="setupForm">
            <div class="form-group">
                <label for="month">Select Month</label>
                <input type="month" id="month" required>
            </div>
            <div class="form-group">
                <label for="currency">Currency</label>
                <select id="currency" required>
                    <option value="">Choose currency...</option>
                    <option value="$">$ USD</option>
                    <option value="€">€ EUR</option>
                    <option value="£">£ GBP</option>
                    <option value="¥">¥ JPY</option>
                    <option value="₹">₹ INR</option>
                    <option value="PKR">PKR</option>
                </select>
            </div>
            <button type="submit" class="btn-primary">Start Planning</button>
        </form>
    </div>
</div>

<!-- MAIN CONTENT -->
<div id="mainContent" class="hidden">
    <header>
        <div class="editable-header">
            <div class="editable-field">
                <label>Month:</label>
                <input type="month" id="editMonth">
            </div>
            <div class="editable-field">
                <label>Currency:</label>
                <select id="editCurrency">
                    <option value="$">$ USD</option>
                    <option value="€">€ EUR</option>
                    <option value="£">£ GBP</option>
                    <option value="¥">¥ JPY</option>
                    <option value="₹">₹ INR</option>
                    <option value="PKR">PKR</option>
                </select>
            </div>
        </div>
        <h1 id="monthHeading">Budget Dashboard</h1>
        <h2>Budget Dashboard</h2>
    </header>

    <!-- SUMMARY CARDS -->
    <div class="summary-cards">
        <div class="card"><h3>Total Income</h3><div class="amount" id="totalIncome">0</div></div>
        <div class="card"><h3>Expenses</h3><div class="amount" id="totalExpenses">0</div></div>
        <div class="card"><h3>Bills</h3><div class="amount" id="totalBills">0</div></div>
        <div class="card"><h3>Savings</h3><div class="amount" id="totalSavings">0</div></div>
        <div class="card"><h3>Debt</h3><div class="amount" id="totalDebt">0</div></div>
    </div>

    <!-- CHARTS -->
    <div class="charts-container">
        <div class="chart-card"><h3>Amount Left to Spend</h3><canvas id="donutChart"></canvas></div>
        <div class="chart-card"><h3>Category Breakdown</h3><canvas id="barChart"></canvas></div>
        <div class="chart-card"><h3>Budget Distribution</h3><canvas id="pieChart"></canvas></div>
    </div>

    <!-- TABLES -->
    <div class="tables-container">
        <!-- Income -->
        <div class="table-card">
            <h3>Income</h3>
            <table id="incomeTable">
                <thead><tr><th>Description</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" class="add-row-container"><button class="btn-icon" onclick="addRow('income')">+</button></td></tr>
                    <tr class="total-row"><td>Total</td><td id="incomeTotal" colspan="2">0</td><td></td></tr>
                </tfoot>
            </table>
        </div>
        <!-- Expenses -->
        <div class="table-card">
            <h3>Expenses</h3>
            <table id="expensesTable">
                <thead><tr><th>Description</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" class="add-row-container"><button class="btn-icon" onclick="addRow('expenses')">+</button></td></tr>
                    <tr class="total-row"><td>Total</td><td id="expensesTotal" colspan="2">0</td><td></td></tr>
                </tfoot>
            </table>
        </div>
        <!-- Bills -->
        <div class="table-card">
            <h3>Bills</h3>
            <table id="billsTable">
                <thead><tr><th>Description</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" class="add-row-container"><button class="btn-icon" onclick="addRow('bills')">+</button></td></tr>
                    <tr class="total-row"><td>Total</td><td id="billsTotal" colspan="2">0</td><td></td></tr>
                </tfoot>
            </table>
        </div>
        <!-- Savings -->
        <div class="table-card">
            <h3>Savings</h3>
            <table id="savingsTable">
                <thead><tr><th>Description</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" class="add-row-container"><button class="btn-icon" onclick="addRow('savings')">+</button></td></tr>
                    <tr class="total-row"><td>Total</td><td id="savingsTotal" colspan="2">0</td><td></td></tr>
                </tfoot>
            </table>
        </div>
        <!-- Debt -->
        <div class="table-card">
            <h3>Debt</h3>
            <table id="debtTable">
                <thead><tr><th>Description</th><th>Amount</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" class="add-row-container"><button class="btn-icon" onclick="addRow('debt')">+</button></td></tr>
                    <tr class="total-row"><td>Total</td><td id="debtTotal" colspan="2">0</td><td></td></tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="actions-bar">
        <button class="btn-action btn-export" onclick="exportToPDF()">Export to PDF</button>
        <button class="btn-action btn-clear" onclick="clearAllData()">Clear All Data</button>
    </div>
</div>

<script>
/* ---------- DATA MODEL ---------- */
let currency = '$';
let charts = {};
let budgetData = {
    month: '',
    currency: '',
    income: [], expenses: [], bills: [], savings: [], debt: []
};

/* ---------- HELPERS ---------- */
function formatMonth(str){ return str ? new Date(str+'-01').toLocaleDateString('default',{month:'long',year:'numeric'}) : 'Month'; }
function formatCurrency(v){ 
    // if currency is a word like PKR, add a space for readability
    const c = currency || '';
    return (c.length > 1 && !['$','€','£','¥','₹'].includes(c) ? c + ' ' : c) + Number(v).toFixed(2);
}
function getTableTotal(id){
    const txt = document.getElementById(id).textContent;
    return parseFloat(txt.replace(/[^\d.-]/g,''))||0;
}

/* ---------- INITIALISATION ---------- */
document.addEventListener('DOMContentLoaded',()=>{
    loadData();
    const now = new Date().toISOString().slice(0,7);
    document.getElementById('month').value = now;               // default month in popup
    if(budgetData.month){
        showMain();
        initializeDashboard();
    }
});

function showMain(){
    document.getElementById('popup').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
}

/* ---------- POPUP SUBMIT ---------- */
document.getElementById('setupForm').addEventListener('submit',e=>{
    e.preventDefault();
    budgetData.month = document.getElementById('month').value;
    budgetData.currency = document.getElementById('currency').value;
    currency = budgetData.currency || '$';
    showMain();
    initializeDashboard();
    saveData();
});

/* ---------- DASHBOARD SETUP ---------- */
function initializeDashboard(){
    // Header
    document.getElementById('monthHeading').textContent = formatMonth(budgetData.month);
    document.getElementById('editMonth').value = budgetData.month;
    document.getElementById('editCurrency').value = budgetData.currency || '$';

    // Edit listeners
    document.getElementById('editMonth').addEventListener('change',()=>{
        budgetData.month=document.getElementById('editMonth').value; 
        document.getElementById('monthHeading').textContent=formatMonth(budgetData.month); 
        saveData();
    });
    document.getElementById('editCurrency').addEventListener('change',()=>{
        budgetData.currency=document.getElementById('editCurrency').value; 
        currency=budgetData.currency || '$'; 
        updateAll(); 
        saveData();
    });

    // IMPORTANT: initialize charts first so updateData/updateAll can safely update them while rows are added.
    initCharts();

    // Load rows (now safe — charts exist)
    ['income','expenses','bills','savings','debt'].forEach(cat=>{
        budgetData[cat].forEach(it=>addRow(cat,it.description,it.amount));
        updateData(cat);
    });

    updateAll();
}

/* ---------- ROW HANDLING ---------- */
function addRow(cat,desc='',amt=''){
    const tbody = document.getElementById(cat+'Table').querySelector('tbody');
    const tr = tbody.insertRow();
    // escape values for safety (basic)
    const safeDesc = String(desc || '').replace(/"/g,'&quot;');
    const safeAmt = (amt !== undefined && amt !== null) ? amt : '';
    tr.innerHTML = `
        <td><input type="text" placeholder="Description" value="${safeDesc}" oninput="updateData('${cat}')"></td>
        <td><input type="number" placeholder="0.00" value="${safeAmt}" min="0" step="0.01" oninput="updateData('${cat}')"></td>
        <td><button class="btn-icon btn-remove" onclick="removeRow(this,'${cat}')">-</button></td>
    `;
    updateData(cat);
}
function removeRow(btn,cat){
    btn.closest('tr').remove();
    updateData(cat);
}

/* ---------- TABLE UPDATE ---------- */
function updateData(cat){
    const tbody = document.getElementById(cat+'Table').querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    let total = 0;
    budgetData[cat] = [];

    rows.forEach(r=>{
        const desc = r.cells[0].querySelector('input').value.trim();
        const amt  = parseFloat(r.cells[1].querySelector('input').value)||0;
        total += amt;
        if(desc||amt>0) budgetData[cat].push({description:desc,amount:amt});
    });

    document.getElementById(cat+'Total').textContent = formatCurrency(total);
    updateAll();
    saveData();
}

/* ---------- SUMMARY & CHARTS ---------- */
function updateAll(){
    // Summary cards
    document.getElementById('totalIncome').textContent   = formatCurrency(getTableTotal('incomeTotal'));
    document.getElementById('totalExpenses').textContent = formatCurrency(getTableTotal('expensesTotal'));
    document.getElementById('totalBills').textContent    = formatCurrency(getTableTotal('billsTotal'));
    document.getElementById('totalSavings').textContent  = formatCurrency(getTableTotal('savingsTotal'));
    document.getElementById('totalDebt').textContent     = formatCurrency(getTableTotal('debtTotal'));

    // Chart data
    const income = getTableTotal('incomeTotal');
    const exp    = getTableTotal('expensesTotal');
    const bill   = getTableTotal('billsTotal');
    const sav    = getTableTotal('savingsTotal');
    const debt   = getTableTotal('debtTotal');
    const spent  = exp + bill + sav + debt;
    const left   = Math.max(0, income - spent);

    // Update charts only if they exist (defensive)
    try {
        if(charts && charts.donut && charts.bar && charts.pie){
            // Donut
            charts.donut.data.datasets[0].data = [spent, left];
            charts.donut.update();

            // Bar
            charts.bar.data.datasets[0].data = [exp, bill, sav, debt];
            charts.bar.update();

            // Pie
            charts.pie.data.datasets[0].data = [debt, exp, bill, sav];
            charts.pie.update();
        }
    } catch (err) {
        // swallow chart errors so UI doesn't break — log for debugging
        console.warn('Chart update error:', err);
    }
}

/* ---------- CHART INITIALISATION ---------- */
function initCharts(){
    const col = {brown:'#a68a6d', light:'#c9b8a3', dark:'#8b7355', beige:'#e8dfd3'};

    // Destroy any existing charts to avoid duplicates when re-initializing
    try {
        if(charts.donut && typeof charts.donut.destroy === 'function') charts.donut.destroy();
        if(charts.bar && typeof charts.bar.destroy === 'function') charts.bar.destroy();
        if(charts.pie && typeof charts.pie.destroy === 'function') charts.pie.destroy();
    } catch(e){ /* ignore */ }

    // Donut
    charts.donut = new Chart(document.getElementById('donutChart'),{
        type:'doughnut',
        data:{
            labels:['Spent','Remaining'],
            datasets:[{data:[0,0],backgroundColor:[col.brown,col.beige],borderWidth:0}]
        },
        options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });

    // Bar
    charts.bar = new Chart(document.getElementById('barChart'),{
        type:'bar',
        data:{
            labels:['Expenses','Bills','Savings','Debt'],
            datasets:[{label:'Amount',data:[0,0,0,0],backgroundColor:[col.brown,col.light,col.dark,col.beige],borderWidth:0}]
        },
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Pie
    charts.pie = new Chart(document.getElementById('pieChart'),{
        type:'pie',
        data:{
            labels:['Debt','Expenses','Bills','Savings'],
            datasets:[{data:[0,0,0,0],backgroundColor:[col.brown,col.light,col.dark,col.beige],borderWidth:0}]
        },
        options:{responsive:true,plugins:{legend:{position:'bottom'}}}
    });
}

/* ---------- STORAGE ---------- */
function saveData(){ localStorage.setItem('budgetPlannerData',JSON.stringify(budgetData)); }
function loadData(){
    const s = localStorage.getItem('budgetPlannerData');
    if(s){
        try {
            budgetData = JSON.parse(s);
            currency = budgetData.currency || '$';
        } catch(e){
            // corrupt storage: reset
            localStorage.removeItem('budgetPlannerData');
            budgetData = { month:'', currency:'', income:[], expenses:[], bills:[], savings:[], debt:[] };
            currency = '$';
        }
    }
}
function clearAllData(){
    if(confirm('Clear all data?')){ localStorage.removeItem('budgetPlannerData'); location.reload(); }
}

/* ---------- EXPORT ---------- */

function exportToPDF(){
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    let y = 20;
    const incTot = getTableTotal('incomeTotal');

    // Header
    doc.setFillColor(166,138,109); doc.rect(0,0,210,30,'F');
    doc.setTextColor(255,255,255); doc.setFontSize(24);
    doc.text('Monthly Budget Planner',105,15,{align:'center'});
    doc.setFontSize(12);
    doc.text(`${formatMonth(budgetData.month)} - ${budgetData.currency}`,105,23,{align:'center'});

    y = 40; doc.setTextColor(107,93,82);
    doc.setFontSize(14); doc.setFont(undefined,'bold'); doc.text('Budget Summary',15,y); y+=15;
    doc.setFontSize(10); doc.setFont(undefined,'normal');

    const sumRows = [
        ['Income',formatCurrency(incTot)],
        ['Expenses',formatCurrency(getTableTotal('expensesTotal'))],
        ['Bills',formatCurrency(getTableTotal('billsTotal'))],
        ['Savings',formatCurrency(getTableTotal('savingsTotal'))],
        ['Debt',formatCurrency(getTableTotal('debtTotal'))]
    ];
    sumRows.forEach(([l,v])=>{
        doc.setFillColor(245,241,232);
        doc.roundedRect(15,y-4,180,8,2,2,'F');
        doc.text(l+':',20,y);
        doc.setFont(undefined,'bold');
        doc.text(v,185,y,{align:'right'});
        doc.setFont(undefined,'normal');
        y+=10;
    });
    y += 25;
    doc.setFontSize(16); doc.setFont(undefined,'bold'); 
    doc.text('Visual Analytics',105,y,{align:'center'});y+=25;
    ['barChart'].forEach((id,i)=>{
        if(y>200){doc.addPage(); y=20;}
        const canvas = document.getElementById(id);
        // protect against missing / empty charts
        if(canvas && canvas.toDataURL){
            const img = canvas.toDataURL('image/png');
            doc.addImage(img,'PNG',15,y,180,80);
            y+=85;
        }
    });

    // Charts (as images)
    doc.addPage(); y=40;
    doc.setFontSize(16); doc.setFont(undefined,'bold');
    ['donutChart','pieChart'].forEach((id,i)=>{
        if(y>200){doc.addPage(); y=20;}
        const canvas = document.getElementById(id);
        // protect against missing / empty charts
        if(canvas && canvas.toDataURL){
            const img = canvas.toDataURL('image/png');
            doc.addImage(img,'PNG',15,y,180,80);
            y+=85;
        }
        y+=35;
    });

    // Tables
    ['income','expenses','bills','savings','debt'].forEach(cat=>{
        doc.addPage(); y=20;
        doc.setFillColor(166,138,109); doc.rect(0,0,210,20,'F');
        doc.setTextColor(255,255,255); doc.setFontSize(18);
        doc.text(cat.charAt(0).toUpperCase()+cat.slice(1),105,13,{align:'center'});
        y=30; doc.setTextColor(107,93,82); doc.setFontSize(10);
        // header
        doc.setFillColor(245,241,232); doc.rect(15,y,180,8,'F');
        doc.setFont(undefined,'bold');
        doc.text('Description',20,y+5); doc.text('Amount',175,y+5,{align:'right'});
        doc.setFont(undefined,'normal'); y+=15;
        // rows
        budgetData[cat].forEach(it=>{
            if(y>270){doc.addPage(); y=20;}
            doc.text(it.description||'-',20,y);
            doc.text(formatCurrency(it.amount),175,y,{align:'right'});
            y+=7;
        });
        // total
        y+=3;
        doc.setFillColor(166,138,109); doc.rect(15,y-4,180,8,'F');
        doc.setTextColor(255,255,255); doc.setFont(undefined,'bold');
        doc.text('Total',20,y);
        doc.text(formatCurrency(getTableTotal(cat+'Total')),175,y,{align:'right'});
        doc.setTextColor(107,93,82); doc.setFont(undefined,'normal');
    });

    doc.save(`Budget_${budgetData.month}.pdf`);
}
</script>
</body>
</html>
